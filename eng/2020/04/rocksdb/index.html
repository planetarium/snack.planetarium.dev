<!doctype html><html lang=en prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=description content><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=keywords content><meta property="og:type" content="article"><meta property="og:description" content><meta property="og:title" content="Applying RocksDB to Libplanet"><meta property="og:site_name" content="Planetarium Engineering Snack"><meta property="og:image" content="https://snack.planetarium.dev/og/eng.png"><meta property="og:url" content="https://snack.planetarium.dev/eng/2020/04/rocksdb/"><meta property="og:locale" content="en"><meta property="article:published_time" content="2020-04-17"><meta property="article:modified_time" content="2020-04-17"><meta name=twitter:card content="summary"><meta name=twitter:site content="@"><meta name=twitter:creator content="@"><meta name=twitter:title content="Applying RocksDB to Libplanet | Planetarium Engineering Snack"><meta name=twitter:description content="Hello, I&rsquo;m Seunghun Lee, Libplanet developer at Planetarium.
Libplanet provides a storage layer abstraction interface called IStore and its basic implementation called DefaultStore. DefaultStore had been used to develop Nine Chronicles and although it was included as a base in Libplanet and had the upside of being able to use it immediately, there were certainly limitations in terms of performance and storage efficiency.
After reviewing various alternative storage methods, we decided that RocksDB, a Key-Value Database library developed by Facebook, was our best option.|"><meta name=twitter:image:src content><meta name=twitter:domain content="https://snack.planetarium.dev/eng/2020/04/rocksdb/"><title>Applying RocksDB to Libplanet</title><link rel=canonical href=https://snack.planetarium.dev/eng/2020/04/rocksdb/><link rel=alternate href=https://snack.planetarium.dev/kor/2020/04/rocksdb/ hreflang=ko title="Libplanet RocksDB 적용기"><link href=https://snack.planetarium.dev/index.xml rel=alternate type=application/atom+xml title="Applying RocksDB to Libplanet"><link rel=stylesheet href=https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css><link rel=stylesheet href=https://snack.planetarium.dev/css/style.min.e1d6437358a5772f79ae0fd01e6ee2736e7fc6536065652581cf2a9c461d4bb0.css integrity="sha256-4dZDc1ildy95rg/QHm7ic25/xlNgZWUlgc8qnEYdS7A="><script async src="https://www.googletagmanager.com/gtag/js?id=UA-132504786-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-132504786-2');</script><link rel=icon href=/favicon-32x32.png type=image/png sizes=32x32><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=/apple-touch-icon.png></head><body class="sans-serif w-90 w-60-ns center center-ns mv2 mv5-ns" itemscope itemtype=http://schema.org/Article><a href=https://snack.planetarium.dev/eng/ id=site-title class="b bb bw1 pb1 no-underline dark-gray">Planetarium Engineering Snack</a><section id=main class=mt5><h1 itemprop=name id=title class=mb1>Applying RocksDB to Libplanet</h1><div class="f6 gray dib-ns"><time itemprop=datePublished datetime=2020-04-17>April 17, 2020</time>
(<strong>English</strong>
&bull;
<a href=https://snack.planetarium.dev/kor/2020/04/rocksdb/ hreflang=ko title="Libplanet RocksDB 적용기" class=gray>한국어</a>)</div><article itemprop=articleBody id=content class="w-100 lh-copy"><p>Hello, I&rsquo;m Seunghun Lee, <a href=https://libplanet.io/>Libplanet</a> developer at Planetarium.</p><p>Libplanet provides a storage layer abstraction interface called <a href=https://docs.libplanet.io/0.8.0/api/Libplanet.Store.IStore.html><code>IStore</code></a> and its basic implementation called <a href=https://docs.libplanet.io/0.8.0/api/Libplanet.Store.DefaultStore.html><code>DefaultStore</code></a>. <code>DefaultStore</code> had been used to develop <a href=https://nine-chronicles.com/>Nine Chronicles</a> and although it was included as a base in Libplanet and had the upside of being able to use it immediately, there were certainly limitations in terms of performance and storage efficiency.</p><p>After reviewing various alternative storage methods, we decided that <a href=https://rocksdb.org/>RocksDB</a>, a <a href=https://en.wikipedia.org/wiki/Key-value_database>Key-Value Database</a> library developed by Facebook, was our best option. We decided to create an <code>IStore</code> implementation called <a href=https://github.com/planetarium/libplanet/blob/master/Libplanet.RocksDBStore/RocksDBStore.cs><code>RocksDBStore</code></a> to use as a backend. In this article, I would like to share our experiences in developing <code>RocksDBStore</code>.</p><h2 id=including-dependent-libraries1>Including Dependent Libraries<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></h2><p>RocksDB relies on other libraries for compression or memory allocation purposes. Unlike <a href=https://github.com/facebook/rocksdb/wiki/Building-on-Windows>Windows build</a>, for macOS and Linux, the dependent libraries must also be installed in the system to use the RocksDB native library in the form of dynamic link libraries (<em>.so</em> and .<em>dylib</em>).</p><p>In a typical server app, it is natural to install all dependent libraries in your system. This is because the system that runs the server app is usually operated only for that server app. But because we&rsquo;re building an app that serves as blockchain nodes and runs on gamers&rsquo; systems, it&rsquo;s hard to ask all gamers to install these libraries separately.</p><p>So what we came up with was to put the libraries that RocksDB relies on in the game client and distribute them. However, building RocksDB in the form of a dynamic link library without any modifications caused the built RocksDB library to not be able to find the dependent libraries that were included in the game clients.</p><p>To resolve this issue, we used a method of modifying <a href=https://en.wikipedia.org/wiki/Rpath>rpath</a> in the RocksDB dynamic link library file. rpath refers to <q>run-time search path</q>, which is hard-coded within a library file or executable file so the <a href=https://en.wikipedia.org/wiki/Dynamic_linker>dynamic linking</a> <a href=https://en.wikipedia.org/wiki/Loader_(computing)>loader</a> can find the required library in that file. Initially, we considered modifying the rpath when building the RocksDB library, but we eventually decided to modify the rpath in the completed library file because the build script in RocksDB turned out to be more complicated than we thought. Fortunately, with tools called <a href=https://www.unix.com/man-page/osx/1/install_name_tool/><code>install_name_tool</code></a> on macOS and <a href=https://github.com/NixOS/patchelf><code>patchelf</code></a> on Linux, you can simply modify the rpath to the directory where the current RocksDB library exists.</p><div class=highlight><pre style=background-color:#fff><code class=language-bash data-lang=bash><span style=color:#888># macOS</span>
$ install_name_tool -add_rpath <span style=color:#d20;background-color:#fff0f0>&#39;@loader_path&#39;</span> librocksdb.dylib

<span style=color:#888># linux</span>
$ patchelf --set-rpath <span style=color:#369>$ORIGIN</span> librocksdb.so
</code></pre></div><p>For more information on rpath modification, please refer to the pages below:</p><ul><li><a href=https://medium.com/@donblas/fun-with-rpath-otool-and-install-name-tool-e3e41ae86172>Fun with rpath, otool, and install_name_tool</a></li><li><a href=https://mindonmind.github.io/notes/linux/change_rpath.html>Change Library Search Path For Binary Files in Linux</a></li></ul><h2 id=implementing-database-capabilities-in-applications>Implementing Database Capabilities in Applications</h2><p>RocksDB supports relatively simple functionality, unlike the common <a href=https://en.wikipedia.org/wiki/Relational_database>relational database</a> or <a href=https://www.litedb.org/>LiteDB</a> used in <code>DefaultStore</code>. Therefore, commonly supported features are often required to be directly implemented by the application when using RocksDB.</p><p>For instance, since there is no method to count the number of rows of stored data, it is necessary to implement them using various ways, such as storing the number separately every time data is updated or counting while traversing the entire data on each update.</p><p>Another example is the key search feature. RocksDB&rsquo;s <code>Seek</code> takes the prefix of the key as input to locate the key. While it&rsquo;s easy to assume that this feature will only find keys that match the prefix like a typical database search, it&rsquo;s actually more similar to <a href=http://man7.org/linux/man-pages/man2/lseek.2.html><code>lseek()</code></a>, which moves the offset of the file. Therefore, when using this feature to traverse a key, you need to check at each key that the first head of that key matches the string parts you are looking for.</p><h2 id=common-mistakes-when-overlooking-the-docs>Common Mistakes when Overlooking the Docs</h2><p>The APIs and documentation of RocksDB were not as user-friendly as expected, so extra attention was needed to use it.</p><p>One example was the <a href=https://github.com/facebook/rocksdb/wiki/Column-Families>Column Family</a>, which acts like a namespace. After creating a column family in the database, we expected the column family to be brought up automatically when using the database again. However, an exception occurs if we did not specify all column families in the database using the API called <code>ListColumnFamilies</code> when opening the database.</p><p>Also, although RocksDB uses GitHub Wiki for documentation, there is no separate arrangement such as documents divided by version. For example, if you look at the document for <a href=https://github.com/facebook/rocksdb/wiki/Prefix-Seek>prefix seek</a>, the most recent usage is written at the end of the document, making it easy to use the outdated one if you only read the first part of the document.</p><h2 id=problems-with-binding-libraries>Problems with Binding Libraries</h2><p>Finally, let’s talk about <a href=https://github.com/warrenfalk/rocksdb-sharp>rocksdb-sharp</a>, a C# binding library of RocksDB.</p><p>Among <code>RocksDBStore</code> codes, one code handles <code>RocksDBException</code> of rocksdb-sharp. But on some platforms, we experienced the following unusual issue while handling this exception.</p><pre><code>ExecutionEngineException: String conversion error: Illegal byte sequence encounted in the input.
</code></pre><p>After looking at the code, we figured out that this was caused by rocksdb-sharp using the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.marshal.ptrtostringansi?view=netframework-4.8"><code>Marshal.PtrToStringAnsi()</code></a> method when encoding an error message generated by RocksDB. Since we were forking rocksdb-sharp to solve the library dependency problem discussed above, we were able to solve the problem without much difficulty by changing the particular method to <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.marshal.ptrtostringuni?view=netframework-4.8"><code>Marshal.PtrToStringUni()</code></a>.</p><h2 id=closing>Closing</h2><p>Through many different processes, we have applied RocksDB and experienced improvements in storage space and speed. Please refer to our <a href=https://github.com/planetarium/libplanet/blob/master/Libplanet.RocksDBStore/RocksDBStore.cs>code</a> for detailed implementation.</p><p>And as always, if you have any questions about RocksDBStore or Libplanet in general, please visit our <a href=https://discord.gg/planetarium>Discord</a> and let’s chat!</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>We took this approach during this phase because Nine Chronicles was being tested to only a small number of players, enabling us to distribute files without an installer. However, now that we’re deploying Nine Chronicles with an installer, other approaches have been developed. We will introduce some of them on Snack in the near future. <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></article><script>(function(){if(!location.hash.match(/^#/)){return;}
var article=document.getElementById('content');var id=window.decodeURIComponent(location.hash.substring(1));var heading=document.getElementById(id);var match=heading.nodeName.match(/^H([123456])$/);if(!match||heading.parentNode!==article){return;}
var headingLevel=window.parseInt(match[1]);var highlighted=false;for(var i=0;i<article.childNodes.length;i++){var child=article.childNodes[i];if(highlighted){match=child.nodeName.match(/^H([123456])$/);if(match&&window.parseInt(match[1])>=headingLevel){highlighted=false;}}
else if(child===heading){highlighted=true;}
if(!highlighted&&!child.nodeName.match(/^#/)){child.className+=' dim';}}})();</script><div itemprop=author class="fl tc mr3"><a href=https://github.com/earlbread rel=author itemprop=url class="no-underline mid-gray b f6"><img src="https://www.gravatar.com/avatar/b1267859758f31ce5f6db0af2042e846?d=https://avatars.githubusercontent.com/earlbread" itemprop=image class="w3 h3 br-100 mb1"><br>Seunghun Lee</a></div></section><footer><div><p class="f6 gray mt6 lh-copy">&copy; 2019&ndash;2021
<a href=https://planetariumhq.com/ style=color:inherit;text-decoration:inherit>Planetarium</a>.</p></div></footer></body></html>