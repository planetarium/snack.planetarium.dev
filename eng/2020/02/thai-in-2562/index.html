<!doctype html><html lang=en prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=description content><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=keywords content><meta property="og:type" content="article"><meta property="og:description" content><meta property="og:title" content="Software from Year 2562 Emerges in Thailand?"><meta property="og:site_name" content="Planetarium Engineering Snack"><meta property="og:image" content="https://snack.planetarium.dev/eng/2020/02/thai-in-2562/1.png"><meta property="og:image" content="https://snack.planetarium.dev/eng/2020/02/thai-in-2562/2.png"><meta property="og:image" content="https://snack.planetarium.dev/og/eng.png"><meta property="og:url" content="https://snack.planetarium.dev/eng/2020/02/thai-in-2562/"><meta property="og:locale" content="en"><meta property="article:published_time" content="2020-02-25"><meta property="article:modified_time" content="2020-02-25"><meta name=twitter:card content="summary"><meta name=twitter:site content="@"><meta name=twitter:creator content="@"><meta name=twitter:title content="Software from Year 2562 Emerges in Thailand? | Planetarium Engineering Snack"><meta name=twitter:description content="Guest from the Future Last December, we finally conducted our first alpha test, and thankfully, many people from all over the world participated. It was both a great opportunity and a challenge for the team. Of course, there were big and small problems. Among them, one problem that took us by surprise was IBD.
IBD is a stage that occurs when you turn on a game, download blocks from other peers in the network and sync them to the latest state.|"><meta name=twitter:image:src content><meta name=twitter:domain content="https://snack.planetarium.dev/eng/2020/02/thai-in-2562/"><title>Software from Year 2562 Emerges in Thailand?</title><link rel=canonical href=https://snack.planetarium.dev/eng/2020/02/thai-in-2562/><link rel=alternate href=https://snack.planetarium.dev/kor/2020/02/thai-in-2562/ hreflang=ko title="태국에서만 2562년으로 가는 소프트웨어?"><link href=https://snack.planetarium.dev/index.xml rel=alternate type=application/atom+xml title="Software from Year 2562 Emerges in Thailand?"><link rel=stylesheet href=https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css><link rel=stylesheet href=https://snack.planetarium.dev/css/style.min.e1d6437358a5772f79ae0fd01e6ee2736e7fc6536065652581cf2a9c461d4bb0.css integrity="sha256-4dZDc1ildy95rg/QHm7ic25/xlNgZWUlgc8qnEYdS7A="><script async src="https://www.googletagmanager.com/gtag/js?id=UA-132504786-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-132504786-2');</script><link rel=icon href=/favicon-32x32.png type=image/png sizes=32x32><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=/apple-touch-icon.png></head><body class="sans-serif w-90 w-60-ns center center-ns mv2 mv5-ns" itemscope itemtype=http://schema.org/Article><a href=https://snack.planetarium.dev/eng/ id=site-title class="b bb bw1 pb1 no-underline dark-gray">Planetarium Engineering Snack</a><section id=main class=mt5><h1 itemprop=name id=title class=mb1>Software from Year 2562 Emerges in Thailand?</h1><div class="f6 gray dib-ns"><time itemprop=datePublished datetime=2020-02-25>February 25, 2020</time>
(<strong>English</strong>
&bull;
<a href=https://snack.planetarium.dev/kor/2020/02/thai-in-2562/ hreflang=ko title="태국에서만 2562년으로 가는 소프트웨어?" class=gray>한국어</a>)</div><article itemprop=articleBody id=content class="w-100 lh-copy"><h2 id=guest-from-the-future>Guest from the Future</h2><p>Last December, we finally conducted our first alpha test, and thankfully, many people from all over the world participated. It was both a great opportunity and a challenge for the team. Of course, there were big and small problems. Among them, one problem that took us by surprise was IBD.</p><p><abbr title="initial block download">IBD</abbr> is a stage that occurs when you turn on a game, download blocks from other peers in the network and sync them to the latest state. Since we had participants from all over the world, IBD often took a long time or even ended abnormally due to network delays.</p><p>One of our participants reported a very unusual symptom. Unlike other problems we had at that time, the participant successfully downloaded the first block but couldn’t download the rest afterward.</p><figure><img src=1.png alt="Screenshot of Our Participant"><figcaption><p>Screenshot of Our Participant</p></figcaption></figure><p>We checked the screenshot our user sent us and realized one strange thing. The date was 2562 instead of 2019. So we came up with a hypothesis. For some reason, the file system was broken and the hash of the block header was being miscalculated.</p><p>To verify this, we asked for permission to investigate the problem directly through remote desktop.</p><h2 id=the-date-was-not-wrong>The Date Was Not Wrong</h2><p>Fortunately, the user experiencing this problem kindly accepted our request for remote access. And once we were able to access the desktop, we saw that the date was still in 2562 as it appeared in the screenshot. First, we opened the Control Panel to sync time. Like most modern operating systems, Windows has the ability to synchronize time over the network. But when we resynchronized time, the control panel and the system&rsquo;s year didn&rsquo;t change and remained in 2562. Notably, apart from the year, date and time were no different from the system on our side.</p><p>We decided to explore the problem a little bit more, and while checking out the control panel, one detail caught our attention.</p><figure><img src=2.png alt="Year Displayed as 2019 in Gregorian calendar"><figcaption><p>Year Displayed as 2019 in Gregorian calendar</p></figcaption></figure><p>No one in our development team could read Thai, but looking at &ldquo;Date in Gregorian”, we noticed that &ldquo;2562&rdquo; was a different expression of &ldquo;2019&rdquo;. So we changed the format, and as expected, December 16th, 2019 was displayed. And when we launched the game for testing, it went smoothly at the IBD stage.</p><h2 id=buddhist-calendar>Buddhist Calendar</h2><p>Now that we had found a clue and a way to reproduce the issue, we suggested our user to set up the region in the US for the time being, and thankfully, our user agreed to our proposal.</p><p>To reproduce this problem on our side, we changed the regional setting of our OS to Thailand in the local development environment and then ran the unit test of Libplanet. Sure enough, we were able to see some of them fail. The most crucial problem was that the hash of the same block was changing. As we looked closer, the result of <a href=https://github.com/planetarium/libplanet/blob/82aaba0c37591ebf51207038e8c5c122272ce98b/Libplanet/Blocks/Block.cs#L488>serializing <code>Block&lt;T>.Timestamp</code> field</a> in the process of creating a hash input was different than expected. The behavior of the <code>DateTimeOffset.ToString()</code> method was affected by the locale of the operating system.</p><p>In Indochina Peninsula, Buddhism takes the same place as Christianity in Europe. So, instead of the <a href=https://en.wikipedia.org/wiki/Gregorian_calendar>Gregorian calendar</a>, which uses the birth of Jesus Christ as an epoch, countries in Indochina Peninsula had used the <a href=https://en.wikipedia.org/wiki/Buddhist_calendar>Buddhist calendar</a> which takes Buddha’s attainment of parinirvana (nirvana after death) as an epoch. Although countries like Cambodia and Laos eventually took on the Gregorian calendar, Thailand still uses the <a href=https://en.wikipedia.org/wiki/Thai_solar_calendar>Thai solar calendar</a>, which is a solar modification of the traditional Buddhist lunar calendar. Buddha’s parinirvana was in 543 BC, and so the year 2019 A.D. becomes 2562 under the Thai solar calendar.</p><p>As such, the world uses various calendars depending on the cultural region. So when displaying a user interface, time should be displayed in the appropriate date format for each region. In fact, <code>DateTimeOffset.ToString()</code> method has an overload that also receives <a href="https://docs.microsoft.com/en-us/dotnet/api/system.iformatprovider?view=netstandard-2.0"><code>IFormatProvider</code></a> objects as parameters for this purpose. <a href="https://docs.microsoft.com/en-us/dotnet/api/system.globalization.cultureinfo?view=netstandard-2.0"><code>CultureInfo</code></a> is the most common class to implement the <code>IFormatProvider</code> interface. As the name suggests, <code>CultureInfo</code> is the same concept that the Unix family calls locale. As shown below, the result of <code>DateTimeOffset.ToString()</code> method depends on which locale you set up as the parameter.</p><div class=highlight><pre style=background-color:#fff><code class=language-csharp data-lang=csharp>&gt; <span style=color:#080;font-weight:700>using</span> <span style=color:#b06;font-weight:700>System.Globalization</span>;
&gt; <span style=color:#888;font-weight:700>var</span> now = DateTimeOffset.Now;
&gt; now.ToString(<span style=color:#d20;background-color:#fff0f0>&#34;yyyy-MM-ddTHH:mm:ss.ffffffZ&#34;</span>, <span style=color:#080;font-weight:700>new</span> CultureInfo(<span style=color:#d20;background-color:#fff0f0>&#34;ko-KR&#34;</span>))
<span style=color:#d20;background-color:#fff0f0>&#34;2020-02-13T17:37:16.436163Z&#34;</span>
&gt; now.ToString(<span style=color:#d20;background-color:#fff0f0>&#34;yyyy-MM-ddTHH:mm:ss.ffffffZ&#34;</span>, <span style=color:#080;font-weight:700>new</span> CultureInfo(<span style=color:#d20;background-color:#fff0f0>&#34;th-TH&#34;</span>))
<span style=color:#d20;background-color:#fff0f0>&#34;2563-02-13T17:37:16.436163Z&#34;</span>
</code></pre></div><p>However, if you omit the parameter without setting any locale, the method will follow the locale of the environment in which the code is executed. The code below is the result of setting up the operating system region in Korea.</p><div class=highlight><pre style=background-color:#fff><code class=language-csharp data-lang=csharp>&gt; now.ToString(<span style=color:#d20;background-color:#fff0f0>&#34;yyyy-MM-ddTHH:mm:ss.ffffffZ&#34;</span>)
<span style=color:#d20;background-color:#fff0f0>&#34;2020-02-13T17:37:16.436163Z&#34;</span>
</code></pre></div><p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.datetimeoffset.tostring?view=netstandard-2.0#System_DateTimeOffset_ToString">According to the docs, the overload with the omitted parameter</a> follows <a href="https://docs.microsoft.com/en-us/dotnet/api/system.globalization.cultureinfo.currentculture?view=netstandard-2.0"><code>CultureInfo.CurrentCulture</code></a>. As you can infer from its name, the <code>CultureInfo.CurrentCulture</code> property points to the locale of the execution environment. Therefore, you must explicitly specify <a href="https://docs.microsoft.com/en-us/dotnet/api/system.globalization.cultureinfo.invariantculture?view=netstandard-2.0"><code>CultureInfo.InvariantCulture</code></a> if you want a deterministic action at all times regardless of the locale of your execution environment.</p><p>Even though the method may be non-deterministic, the API designed to follow the locale of the execution environment is probably intended because such formatting operations are usually used for a user interface, and coding can naturally look appropriate to the cultural community without much concern about internationalization. But the reason why we used this method was not for a user interface, but for the cryptographic hash input that had to be deterministic— this turned out to be a mistake.</p><p>Now that we know the cause, we have solved the urgent problem by <a href=https://github.com/planetarium/libplanet/pull/734>finding a method that has the <code>CultureInfo</code> or <code>IFormatProvider</code> parameters omitted, and patching it to explicitly designate <code>CultureInfo.InvariantCulture</code>, just like the method <code>DateTimeOffset.ToString()</code></a>.</p><p>CI has also been reinforced with unit testing in Arabic, French, Hebrew locale and so on. Since there are a lot of countries in Europe that use comma (<code>,</code>) instead of a period (<code>.</code>) in decimal places, and countries in the Middle East that writes from right to left, we deliberately chose language regions that were somewhat unfamiliar to us.</p><p>In addition, because similar mistakes can happen in the future, we have <a href=https://github.com/planetarium/libplanet/pull/737>introduced static analysis</a> that finds codes whose behavior depends on the locale of the execution environment.</p><h2 id=closing>Closing</h2><p>As mentioned earlier, using APIs with non-determinant behaviors such as formatting in functions that calculate the cryptographic hash is not a good decision in the long run. Typically, because strings are heavily formatted, it&rsquo;s safe to avoid them from data level perspective.</p><p>But unfortunately, we found this problem in the middle of the test, and we haven&rsquo;t made any major modifications yet because changing the hash method was a decision that would break the compatibility of previous data. However, these parts will be modified before releasing Libplanet 1.0.</p></article><script>(function(){if(!location.hash.match(/^#/)){return;}
var article=document.getElementById('content');var id=window.decodeURIComponent(location.hash.substring(1));var heading=document.getElementById(id);var match=heading.nodeName.match(/^H([123456])$/);if(!match||heading.parentNode!==article){return;}
var headingLevel=window.parseInt(match[1]);var highlighted=false;for(var i=0;i<article.childNodes.length;i++){var child=article.childNodes[i];if(highlighted){match=child.nodeName.match(/^H([123456])$/);if(match&&window.parseInt(match[1])>=headingLevel){highlighted=false;}}
else if(child===heading){highlighted=true;}
if(!highlighted&&!child.nodeName.match(/^#/)){child.className+=' dim';}}})();</script><div itemprop=author class="fl tc mr3"><a href=https://github.com/dahlia rel=author itemprop=url class="no-underline mid-gray b f6"><img src="https://www.gravatar.com/avatar/03acbf60571d4ef2bf3741aecfa1b8cb?d=https://avatars.githubusercontent.com/dahlia" itemprop=image class="w3 h3 br-100 mb1"><br>Hong Minhee</a></div><div itemprop=author class="fl tc mr3"><a href=https://github.com/longfin rel=author itemprop=url class="no-underline mid-gray b f6"><img src="https://www.gravatar.com/avatar/0b12cfcb4b1a472207af0e51f7d13a71?d=https://avatars.githubusercontent.com/longfin" itemprop=image class="w3 h3 br-100 mb1"><br>Swen Mun</a></div></section><footer><div><p class="f6 gray mt6 lh-copy">&copy; 2019&ndash;2021
<a href=https://planetariumhq.com/ style=color:inherit;text-decoration:inherit>Planetarium</a>.</p></div></footer></body></html>