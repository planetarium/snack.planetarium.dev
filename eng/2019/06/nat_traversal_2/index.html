<!doctype html><html lang=en prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=description content>
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=keywords content>
<meta property="og:type" content="article">
<meta property="og:description" content>
<meta property="og:title" content="Understanding TURN through an Example">
<meta property="og:site_name" content="Planetarium Engineering Snack">
<meta property="og:image" content="https://snack.planetarium.dev/og/eng.png">
<meta property="og:url" content="https://snack.planetarium.dev/eng/2019/06/nat_traversal_2/">
<meta property="og:locale" content="en">
<meta property="article:published_time" content="2019-06-18">
<meta property="article:modified_time" content="2019-06-18">
<meta name=twitter:card content="summary">
<meta name=twitter:site content="@">
<meta name=twitter:creator content="@">
<meta name=twitter:title content="Understanding TURN through an Example | Planetarium Engineering Snack">
<meta name=twitter:description content="Hello, I&rsquo;m Swen Mun from the Planetarium Dev Team. I introduced you all to NAT traversal in my earlier post. Today, let’s take a deeper look at TURN.
As the name &ldquo;Traversal Using Relays around NAT&rdquo; suggests, TURN refers to the way servers with authorized IP relay peers that want to communicate. It might be difficult to understand this concept simply by listing the functions and sequences, so let me just give you an example of how we actually use TURN in Libplanet.|">
<meta name=twitter:image:src content>
<meta name=twitter:domain content="https://snack.planetarium.dev/eng/2019/06/nat_traversal_2/">
<title>Understanding TURN through an Example</title>
<link rel=canonical href=https://snack.planetarium.dev/eng/2019/06/nat_traversal_2/>
<link rel=alternate href=https://snack.planetarium.dev/kor/2019/06/nat_traversal_2/ hreflang=ko title="예제로 보는 TURN">
<link href=https://snack.planetarium.dev/index.xml rel=alternate type=application/atom+xml title="Understanding TURN through an Example">
<link rel=stylesheet href=https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css>
<link rel=stylesheet href=https://snack.planetarium.dev/css/style.min.1a35efb5c5da4fd20bd2ec86458da5ee7cc1cfc81c4f107944b5e0fc59a3d809.css integrity="sha256-GjXvtcXaT9IL0uyGRY2l7nzBz8gcTxB5RLXg/Fmj2Ak=">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132504786-2"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-132504786-2')</script>
<link rel=icon href=/favicon-32x32.png type=image/png sizes=32x32>
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon href=/apple-touch-icon.png>
</head>
<body class="sans-serif w-90 w-60-ns center center-ns mv2 mv5-ns" itemscope itemtype=http://schema.org/Article>
<a href=https://snack.planetarium.dev/eng/ id=site-title class="b bb bw1 pb1 no-underline dark-gray">Planetarium Engineering Snack</a>
<section id=main class=mt5>
<h1 itemprop=name id=title class=mb1>Understanding TURN through an Example</h1>
<div class="f6 gray dib-ns">
<time itemprop=datePublished datetime=2019-06-18>
June 18, 2019
</time>
(<strong>English</strong>
&bull;
<a href=https://snack.planetarium.dev/kor/2019/06/nat_traversal_2/ hreflang=ko title="예제로 보는 TURN" class=gray>한국어</a>)
</div>
<article itemprop=articleBody id=content class="w-100 lh-copy">
<p>Hello, I&rsquo;m Swen Mun from the Planetarium Dev Team. I introduced you all to <a href=https://en.wikipedia.org/wiki/NAT_traversal>NAT traversal</a> <a href=https://snack.planetarium.dev/eng/2019/04/nat_traversal_1/>in my earlier post</a>. Today, let’s take a deeper look at <a href=https://en.wikipedia.org/wiki/Traversal_Using_Relays_around_NAT>TURN</a>.</p>
<p>As the name &ldquo;Traversal Using Relays around NAT&rdquo; suggests, TURN refers to the way servers with authorized IP relay peers that want to communicate. It might be difficult to understand this concept simply by listing the functions and sequences, so let me just give you an example of how we actually use TURN in <a href=https://libplanet.io/>Libplanet</a>.</p>
<h2 id=blockchain--nat>Blockchain & NAT</h2>
<p>Libplanet is a library that makes blockchain technology easy to use in game development. Many blockchain implementations use <a href=https://en.wikipedia.org/wiki/Peer-to-peer>P2P</a>-type networks for communications between distributed <a href=https://en.wikipedia.org/wiki/Node_(networking)>nodes</a>, and so does Libplanet. Unlike other implementations, however, the blockchain application implemented through Libplanet is a game. Typically, these games run on personal computers, on non-stop consoles, and on personal devices such as smartphones, most of which do not have a separate, authorized IP on a NAT-configured network. So, applications running on these devices must pass through NAT for P2P communication.</p>
<p>For this reason, Libplanet supports relaying using TURN from 0.2.0. And here&rsquo;s how it works.</p>
<h2 id=port-allocation>Port Allocation</h2>
<p>The first step in relaying over the TURN is a step known as port allocation. Nodes that want to broadcast from outside of NAT send an allocation request (with the appropriate credentials, if necessary) to the TURN server. The request dialogue will be something like this.</p>
<blockquote>
<p>Node: I&rsquo;d like to receive a relay through an authorized IP and port. Please allocate an appropriate IP and port.</p>
</blockquote>
<p>If the request is correct, the TURN server will select and open the appropriate IP and port to receive the connection depending on the settings, and send the following response.</p>
<blockquote>
<p>TURN Server: Port assigned. The address to be relayed in the future is <code>54.12.1.3:65002</code>. (Nonce: <code>xyz</code>)</p>
</blockquote>
<p>This connection that requests port allocation is called <em>control connection</em> and it is used for communications between TURN server and the node. One caveat here is the nonce that the TURN server sends with its response. Nonce is unique for each control connection and the acquired nonce must be included in all requests of the control connection. (Or, you may receive a stale nonce error and request it again.)</p>
<h2 id=authorization-request-and-approval>Authorization Request and Approval</h2>
<p>With the assigned IP and port (<code>54.12.1.3:65002</code>), it would be great if other nodes were able to connect directly, but we need to go through one more step—Authorization Request. This is to request the TURN server to enable the allocated port to connect to other IP nodes. Any connections that have not been requested for authorization are blocked, which means that the node you want to relay must have prior IP information of the node you want to connect to.</p>
<p>But in real life, many users don&rsquo;t know or care about their own public IP, so it&rsquo;s very difficult to communicate this information directly. To resolve this, use cases such as <a href=https://webrtc.org/>WebRTC</a> often figure out the IP information of the node to access at the <a href=https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Signaling_and_video_calling>signaling</a> stage. Meanwhile, Libplanet uses the STUN protocol to check if the IP is behind NAT, and if so, it will send the IP to other nodes along with the IP/port that is relayed as public IP. The nodes that receive this information go through the process of requesting permission first via an public IP before they can access the information that has been relayed.</p>
<p>If a node knows the public IP (<code>10.1.1.1</code>) of another node that it wants to connect to, the authorization request will probably be as follows.</p>
<blockquote>
<p>Node: Requesting Authorization from <code>10.1.1.1</code> to <code>54.12.1.3:65002</code>.</p>
</blockquote>
<p>This access expires after a 300-second lifetime, and to prevent this, the node that requested the authorization must re-request to the TURN server.</p>
<h2 id=connection-notification-and-new-connection-request>Connection Notification and New Connection Request</h2>
<p>After authorization request and approval has been completed, other nodes that have been approved with the allocated IP and port can finally connect. When the nodes make a connection, the TURN server detects it and sends the following message to the control connection.</p>
<blockquote>
<p>TURN Server: A connection attempt was made from <code>10.1.1.1</code> to <code>54.12.1.3:65002</code>. (Connection ID: <code>1234</code>)</p>
</blockquote>
<p>For the node that requested TURN Server relay to accept this connection, it can create a new connection (not the control connection) and request it to the TURN server. In order to distinguish the external connection request, connection ID should be included in the connection notification message.</p>
<blockquote>
<p>Node: Please transfer data from connection ID: <code>1234</code> to this connection from now on.</p>
</blockquote>
<p>This new connection is called a <em>data connection</em>. Subsequent requests to <code>54.12.1.3:65002</code> are passed through this data connection, and responses to the nodes connected to that IP/port are sent to this data connection, goes through the TURN server, and finally to the node.</p>
<h2 id=remaining-steps>Remaining Steps</h2>
<p>In order to actually send a response properly, it is necessary to re-relay the data connections created previously and the request-response connection on the Libplanet node. No separate protocol or disclosure standard has been set because this step only needs to be handled well within the node. If the TURN client runs in a separate process from the web server, you can use the <a href=https://en.wikipedia.org/wiki/Inter-process_communication>IPC</a> method and if they run in the same process, inter-thread communication can be used to handle the communication. In our case, Libplanet relays a separate TCP proxy by running it locally.</p>
</article>
<script>(function(){var d,h,e,a,g,c,f,b;if(!location.hash.match(/^#/))return;if(d=document.getElementById('content'),h=window.decodeURIComponent(location.hash.substring(1)),e=document.getElementById(h),a=e.nodeName.match(/^H([123456])$/),!a||e.parentNode!==d)return;g=window.parseInt(a[1]),c=!1;for(f=0;f<d.childNodes.length;f++)b=d.childNodes[f],c?(a=b.nodeName.match(/^H([123456])$/),a&&window.parseInt(a[1])>=g&&(c=!1)):b===e&&(c=!0),!c&&!b.nodeName.match(/^#/)&&(b.className+=' dim')})()</script>
<div itemprop=author class="fl tc mr3">
<a href=https://github.com/longfin rel=author itemprop=url class="no-underline mid-gray b f6">
<img src="https://www.gravatar.com/avatar/0b12cfcb4b1a472207af0e51f7d13a71?d=https://avatars.githubusercontent.com/longfin" itemprop=image class="w3 h3 br-100 mb1">
<br>Swen Mun
</a>
</div>
</section>
<footer>
<div>
<p class="f6 gray mt6 lh-copy">
&copy; 2019&ndash;2023
<a href=https://planetariumlabs.com/ style=color:inherit;text-decoration:inherit>Planetarium</a>.
</p>
</div>
</footer>
</body>
</html>