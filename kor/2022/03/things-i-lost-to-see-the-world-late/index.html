<!doctype html><html lang=ko prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=description content><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=keywords content><meta property="og:type" content="article"><meta property="og:description" content><meta property="og:title" content="세상을 늦게 보기 위해 잃었던 것들"><meta property="og:site_name" content="플라네타리움 엔지니어링 스낵"><meta property="og:image" content="https://snack.planetarium.dev/og/kor.png"><meta property="og:url" content="https://snack.planetarium.dev/kor/2022/03/things-i-lost-to-see-the-world-late/"><meta property="og:locale" content="ko"><meta property="article:published_time" content="2022-03-29"><meta property="article:modified_time" content="2022-03-29"><meta name=twitter:card content="summary"><meta name=twitter:site content="@"><meta name=twitter:creator content="@"><meta name=twitter:title content="세상을 늦게 보기 위해 잃었던 것들 | 플라네타리움 엔지니어링 스낵"><meta name=twitter:description content="안녕하세요. 플라네타리움 엔진팀에서 Libplanet을 개발하고 있는 이수호입니다. 오늘은 Libplanet을 개발하면서 생겼던 문제 중 블록체인에서 흔히 말하는 확정(Confirmation)으로 인해 생긴 문제와 그 문제를 발견하고 해결하는 과정을 이야기하고자 합니다.
확정(Confirmation) 블록체인에서의 블록은, 어떠한 사건이라고 볼 수 있고 체인은 사건으로 이루어진 일련의 시간 흐름이라고 볼 수 있습니다. 이전의 시간 흐름과는 맞지 않는 사건이 발생했을 때, 관측자는 이 사건을 올바르지 않은 사건으로 분류하고 거절합니다. 이 &lsquo;올바른 사건&rsquo;이라는 규칙을 대다수가 공유하고 있다면, 사건들만 순서대로 공유했을 때에 모두가 같은 현상을 관측하고 있다고 할 수 있습니다.|"><meta name=twitter:image:src content><meta name=twitter:domain content="https://snack.planetarium.dev/kor/2022/03/things-i-lost-to-see-the-world-late/"><title>세상을 늦게 보기 위해 잃었던 것들</title>
<link rel=canonical href=https://snack.planetarium.dev/kor/2022/03/things-i-lost-to-see-the-world-late/><link href=https://snack.planetarium.dev/index.xml rel=alternate type=application/atom+xml title="세상을 늦게 보기 위해 잃었던 것들"><link rel=stylesheet href=https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css><link rel=stylesheet href=https://snack.planetarium.dev/css/style.min.1a35efb5c5da4fd20bd2ec86458da5ee7cc1cfc81c4f107944b5e0fc59a3d809.css integrity="sha256-GjXvtcXaT9IL0uyGRY2l7nzBz8gcTxB5RLXg/Fmj2Ak="><script async src="https://www.googletagmanager.com/gtag/js?id=UA-132504786-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-132504786-2")</script><link rel=icon href=/favicon-32x32.png type=image/png sizes=32x32><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=/apple-touch-icon.png></head><body class="sans-serif w-90 w-60-ns center center-ns mv2 mv5-ns" itemscope itemtype=http://schema.org/Article><a href=https://snack.planetarium.dev/kor/ id=site-title class="b bb bw1 pb1 no-underline dark-gray">플라네타리움 엔지니어링 스낵</a><section id=main class=mt5><h1 itemprop=name id=title class=mb1>세상을 늦게 보기 위해 잃었던 것들</h1><div class="f6 gray dib-ns"><time itemprop=datePublished datetime=2022-03-29>2022년 3월 29일</time></div><article itemprop=articleBody id=content class="w-100 lh-copy"><p>안녕하세요. 플라네타리움 엔진팀에서 <a href=https://libplanet.io/>Libplanet</a>을 개발하고 있는 이수호입니다.
오늘은 <a href=https://libplanet.io/>Libplanet</a>을 개발하면서 생겼던 문제 중 블록체인에서 흔히 말하는 확정(<code>Confirmation</code>)으로 인해 생긴 문제와
그 문제를 발견하고 해결하는 과정을 이야기하고자 합니다.</p><h2 id=확정confirmation>확정(<code>Confirmation</code>)</h2><p>블록체인에서의 블록은, 어떠한 사건이라고 볼 수 있고 체인은 사건으로 이루어진 일련의 시간 흐름이라고 볼 수 있습니다.
이전의 시간 흐름과는 맞지 않는 사건이 발생했을 때, 관측자는 이 사건을 올바르지 않은 사건으로 분류하고 거절합니다.
이 &lsquo;올바른 사건&rsquo;이라는 규칙을 대다수가 공유하고 있다면, 사건들만 순서대로 공유했을 때에 모두가 같은 현상을 관측하고 있다고 할 수 있습니다.</p><p>하지만, 이 서로 다른 &lsquo;올바른 사건&rsquo;이 동시다발적으로 제출된다면 어떻게 될까요?
일시적으로 관측자들 사이에 혼란이 생길 것이지만 결과적으로는 올바른 시간대를 바라보게 됩니다.
하지만 이 혼란으로 인해 관측하고 있는 정보를 기반으로 하고 있는 다른 사용자들은 혼란을 겪게 됩니다.</p><p>예를 들면. 방금 전 사건까지만 해도 분명히 100원이 있었는데, 이 사건이 없던 걸로 되어서 0원이 되어 버린다던가 하는 일들이 생길 수 있습니다.</p><p>이를 막기 위해 사용자는 확정(<code>Confirmation</code>) 이라는 &lsquo;여기서부터는 뒤집히지 않는다&rsquo; 라는 수치를 두고,
이 수치 이전까지는 블록이 들어와도 체인에 받지 않습니다.
세상을 늦게 보고 확실해질 때 까지 기다리는 것이죠.</p><h2 id=libplanet-에서의-확정confirmation과-렌더러renderer>Libplanet 에서의 확정(<code>Confirmation</code>)과 렌더러(<code>Renderer</code>)</h2><p>Libplanet 은 이 확정(<code>Confirmation</code>)을 지원하고 있습니다. 정확히는 렌더링 과정에서 확정(<code>Confirmation</code>)을 거칩니다.
이 렌더링 역할을 해 주는 렌더러(<a href=https://docs.libplanet.io/0.30.0/api/Libplanet.Blockchain.Renderers.IRenderer-1.html>Renderer</a>)는 블록체인의 상태를 수신해서 변경이 일어났을 경우
해당 렌더러의 콜백을 블록체인의 이전 상태,현재 상태와 함께 호출해 주는 역할을 가지고 있습니다.</p><p>이 중에서도 지연 렌더러(<a href=https://docs.libplanet.io/0.30.0/api/Libplanet.Blockchain.Renderers.DelayedRenderer-1.html>DelayedRenderer</a>)는 블록 자체를 늦게 인지하는 것이 아닌 블록을 전부 인지 및 연산한 후에
렌더링 하는 부분만 가지고 있다가 수치가 넘어가면 감싸고 있는 렌더러(<a href=https://docs.libplanet.io/0.30.0/api/Libplanet.Blockchain.Renderers.IRenderer-1.html>Renderer</a>)에 보내줍니다.</p><p>더 자세한 정보는 <a href=https://docs.libplanet.io/0.30.0/api/Libplanet.Blockchain.Renderers.DelayedRenderer-1.html>DelayedRenderer</a>에서 확인할 수 있습니다.</p><h2 id=문제-발생>문제 발생</h2><p>어느 순간, 사용자들에게서 메모리 사용량이 급증한다는 제보를 받았습니다. 켜놓은 지 약 1시간이 지나면 메모리 누수가 심각하게 일어나는 것을 확인할 수 있었습니다.
특정하는 것은 어렵지 않았습니다. <a href=https://www.jetbrains.com/ko-kr/dotmemory/>dotMemory</a>를 사용하니 어떤 클래스에서 메모리를 가장 많이 사용하는지 특정할 수 있었습니다.</p><figure><img src=images/dot-memory.png alt="DelayedActionRenderer 가 가장 많은 메모리 사용량을 차지하고 있는 dotMemory 분석 결과"><figcaption><p>DelayedActionRenderer 가 가장 많은 메모리 사용량을 차지하고 있는 dotMemory 분석 결과</p></figcaption></figure><p>문제는 다음입니다. 왜 메모리 누수가 일어났을까? 눈치가 빠르거나 경험이 많으신 분들은 이미 눈치채셨을지도 모르겠습니다.</p><h2 id=원인-및-해결>원인 및 해결</h2><p>앞에서 언급했던 문구를 다시 가져와 보겠습니다</p><blockquote><p>이를 막기 위해 사용자는 확정(<code>Confirmation</code>) 이라는 &lsquo;여기서부터는 뒤집히지 않는다&rsquo; 라는 수치를 두고,
이 수치 이전까지는 블록이 들어와도 체인에 받지 않습니다.
세상을 늦게 보고 확실해질 때 까지 기다리는 것이죠.</p></blockquote><p>힌트는 <em>여기서부터는 뒤집히지 않는다</em> 입니다.
작업 기반 증명(Proof-Of-Work, PoW)에서는 합의 무결성(Safety)를 보장할 수 없기 때문에, 이것은 그 누구도 보장할 수 없습니다.</p><p>따라서 사용자가 지정한 이 확정(<code>Confirmation</code>) 을 체인 안쪽까지 끌어와서
블록체인 네트워크 엔지니어가 경계 값(Threshold)을 지정할 수 있게 하는 작업이 필요했습니다.
해당 작업의 결과는 <a href=https://github.com/planetarium/libplanet/pull/1163>#1163</a> PR에서 보실 수 있습니다.</p><h2 id=마치며>마치며</h2><p>일련의 모든 블록체인 합의 과정에서의 설명은 모두 작업 기반 증명(Proof-Of-Work, PoW)을 기반으로 설명되었습니다.
지분 기반 증명(Proof-Of-Stake, PoS)나 다른 합의 알고리즘에서는 필요 없는 이야기일 수도 있습니다.</p><p>설명이 조금 모자라거나 틀린 부분이 있으면 의견 남겨주시면 감사하겠습니다.</p></article><script>(function(){if(!location.hash.match(/^#/))return;var t,n,s,a,o=document.getElementById("content"),r=window.decodeURIComponent(location.hash.substring(1)),i=document.getElementById(r),e=i.nodeName.match(/^H([123456])$/);if(!e||i.parentNode!==o)return;for(a=window.parseInt(e[1]),t=!1,s=0;s<o.childNodes.length;s++)n=o.childNodes[s],t?(e=n.nodeName.match(/^H([123456])$/),e&&window.parseInt(e[1])>=a&&(t=!1)):n===i&&(t=!0),!t&&!n.nodeName.match(/^#/)&&(n.className+=" dim")})()</script><div class=recruit><a href=https://planetariumhq.com>플라네타리움</a>은 게임에 특화된
오픈 소스 P2P 라이브러리 <a href=https://libplanet.io/>Libplanet</a>과,
그 위에서 중앙 서버 없는 온라인 게임
〈<a href=https://nine-chronicles.com/>나인 크로니클</a>〉을 만들고
있습니다. 저희와 흥미로운 기술적 도전을 함께 하실 분들을 모시고 있습니다.
지금 <a href=https://recruit.planetariumhq.com/>인재 영입 페이지</a>를
확인해주세요!</div><div itemprop=author class="fl tc mr3"><a href=https://github.com/riemannulus rel=author itemprop=url class="no-underline mid-gray b f6"><img src="https://www.gravatar.com/avatar/9e43b4f2a202a9d7a1e2b180aaaba253?d=https://avatars.githubusercontent.com/riemannulus" itemprop=image class="w3 h3 br-100 mb1"><br>이수호</a></div></section><footer><div><p class="f6 gray mt6 lh-copy">&copy; 2019&ndash;2023
<a href=https://planetariumlabs.com/ style=color:inherit;text-decoration:inherit>Planetarium</a>.</p></div></footer></body></html>