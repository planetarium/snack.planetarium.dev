<!doctype html><html lang=ko prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=description content>
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=keywords content>
<meta property="og:type" content="article">
<meta property="og:description" content>
<meta property="og:title" content="예제로 보는 TURN">
<meta property="og:site_name" content="플라네타리움 엔지니어링 스낵">
<meta property="og:image" content="https://snack.planetarium.dev/og/kor.png">
<meta property="og:url" content="https://snack.planetarium.dev/kor/2019/06/nat_traversal_2/">
<meta property="og:locale" content="ko">
<meta property="article:published_time" content="2019-06-18">
<meta property="article:modified_time" content="2019-06-18">
<meta name=twitter:card content="summary">
<meta name=twitter:site content="@">
<meta name=twitter:creator content="@">
<meta name=twitter:title content="예제로 보는 TURN | 플라네타리움 엔지니어링 스낵">
<meta name=twitter:description content="안녕하세요. 플라네타리움 개발팀 문성원입니다. 지난 시간에 NAT 통과 기법에 대해서 소개해 드렸었는데요. 오늘은 그중에서 TURN을 살펴볼까 합니다.
&ldquo;Traversal Using Relays around NAT&#34;라는 이름에서 알 수 있듯이 TURN은 공인 IP를 가진 서버가 통신을 원하는 단말들을 중계하는 방식을 일컫습니다. 단순히 기능이나 순서를 나열하는 것으론 이해가 어려울 수 있으니, 저희가 만들고 있는 Libplanet이 실제로 TURN을 사용하는 방식을 예로 설명하도록 하겠습니다.
블록 체인과 NAT Libplanet은 블록체인 기술을 게임 개발에 쉽게 사용할 수 있게끔 하는 라이브러리입니다.|">
<meta name=twitter:image:src content>
<meta name=twitter:domain content="https://snack.planetarium.dev/kor/2019/06/nat_traversal_2/">
<title>예제로 보는 TURN</title>
<link rel=canonical href=https://snack.planetarium.dev/kor/2019/06/nat_traversal_2/>
<link rel=alternate href=https://snack.planetarium.dev/eng/2019/06/nat_traversal_2/ hreflang=en title="Understanding TURN through an Example">
<link href=https://snack.planetarium.dev/index.xml rel=alternate type=application/atom+xml title="예제로 보는 TURN">
<link rel=stylesheet href=https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css>
<link rel=stylesheet href=https://snack.planetarium.dev/css/style.min.e1d6437358a5772f79ae0fd01e6ee2736e7fc6536065652581cf2a9c461d4bb0.css integrity="sha256-4dZDc1ildy95rg/QHm7ic25/xlNgZWUlgc8qnEYdS7A=">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132504786-2"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-132504786-2')</script>
<link rel=icon href=/favicon-32x32.png type=image/png sizes=32x32>
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon href=/apple-touch-icon.png>
</head>
<body class="sans-serif w-90 w-60-ns center center-ns mv2 mv5-ns" itemscope itemtype=http://schema.org/Article>
<a href=https://snack.planetarium.dev/kor/ id=site-title class="b bb bw1 pb1 no-underline dark-gray">플라네타리움 엔지니어링 스낵</a>
<section id=main class=mt5>
<h1 itemprop=name id=title class=mb1>예제로 보는 TURN</h1>
<div class="f6 gray dib-ns">
<time itemprop=datePublished datetime=2019-06-18>
2019년 6월 18일
</time>
(<strong>한국어</strong>
&bull;
<a href=https://snack.planetarium.dev/eng/2019/06/nat_traversal_2/ hreflang=en title="Understanding TURN through an Example" class=gray>English</a>)
</div>
<article itemprop=articleBody id=content class="w-100 lh-copy">
<p>안녕하세요. 플라네타리움 개발팀 문성원입니다. 지난 시간에 <a href=https://en.wikipedia.org/wiki/NAT_traversal>NAT 통과 기법</a>에 대해서 <a href=https://snack.planetarium.dev/kor/2019/04/nat_traversal_1/>소개해 드렸었는데요</a>. 오늘은 그중에서 <a href=https://en.wikipedia.org/wiki/Traversal_Using_Relays_around_NAT>TURN</a>을 살펴볼까 합니다.</p>
<p>&ldquo;Traversal Using Relays around NAT"라는 이름에서 알 수 있듯이 TURN은 공인 IP를 가진 서버가 통신을 원하는 단말들을 중계하는 방식을 일컫습니다. 단순히 기능이나 순서를 나열하는 것으론 이해가 어려울 수 있으니, 저희가 만들고 있는 <a href=https://libplanet.io/>Libplanet</a>이 실제로 TURN을 사용하는 방식을 예로 설명하도록 하겠습니다.</p>
<h2 id=블록-체인과-nat>블록 체인과 NAT</h2>
<p>Libplanet은 블록체인 기술을 게임 개발에 쉽게 사용할 수 있게끔 하는 라이브러리입니다. 많은 블록체인 구현체들은 분산된 <a href=https://ko.wikipedia.org/wiki/%EB%85%B8%EB%93%9C_(%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC)>노드(node)</a>간의 통신에 <a href=https://ko.wikipedia.org/wiki/P2P>P2P</a> 형태의 네트워크를 사용하며, 이는 저희 Libplanet도 마찬가지입니다. 다만 다른 블록체인 구현체들과는 다르게, Libplanet을 통해 블록체인이 구현되는 애플리케이션은 게임입니다. 일반적으로 이러한 게임은 개인용 컴퓨터나 거치형 콘솔, 그리고 스마트폰과 같은 개인용 장비에서 실행되는데, 이런 장비의 대부분은 NAT로 구성된 네트워크 위에서 별도의 공인 IP를 가지지 않습니다. 즉 이러한 장비에서 실행되는 애플리케이션이 P2P 통신을 하려면 NAT를 통과하지 않을 수 없습니다.</p>
<p>이때문에 Libplanet은 0.2.0부터 TURN을 이용한 릴레이를 지원합니다. 바로 다음과 같은 과정을 통해서요.</p>
<h2 id=포트-할당>포트 할당</h2>
<p>TURN을 통한 릴레이의 첫 단계는 포트 할당이라고 알려진 단계입니다. NAT 바깥에서 중계를 원하는 노드는 (필요하다면 적절한 인증 정보와 함께) 포트 할당 요청(allocation request)을 TURN 서버로 보냅니다. 적당히 간추리면 대충 이런 내용이겠죠.</p>
<blockquote>
<p>노드: 공인 IP와 포트를 통해 중계를 받고 싶습니다. 적당한 IP와 포트를 할당해주세요.</p>
</blockquote>
<p>TURN 서버는 요청이 올바르다면 설정에 따라 적당한 IP와 포트를 골라서 연결을 받을 수 있게 열어 두고 아래와 같은 응답을 보낼 것입니다.</p>
<blockquote>
<p>TURN 서버: 포트를 할당하였습니다. 앞으로 중계할 할 주소는 <code>54.12.1.3:65002</code>입니다. (논스: <code>xyz</code>)</p>
</blockquote>
<p>이렇게 포트 할당을 요청한 연결은 <dfn>제어 연결</dfn>(control connection)로 불리며, 이후 TURN 서버와 노드의 통신에 사용됩니다.
여기서 한 가지 주의할 점이 TURN 서버가 응답에 포함하는 논스(nonce)인데요. 이 논스는 제어 연결마다 고유하며, 획득한 논스를 이 제어 연결의 모든 요청에 같이 보내줘야 합니다. (혹은 논스 불일치(stale nonce) 에러를 받고 다시 요청하는 방법도 있습니다.)</p>
<h2 id=권한-요청-및-승인>권한 요청 및 승인</h2>
<p>이렇게 할당 받은 IP와 포트(<code>54.12.1.3:65002</code>)로 다른 노드가 바로 접속할 수 있으면 좋겠지만 아직 한 단계가 더 필요합니다. 바로 권한 요청인데요. 이는 포트를 할당받은 노드가 할당 받은 포트를 어떤 IP의 노드에게 접속 가능하게끔 TURN 서버에 요청하는 것입니다. 권한 요청이 되지 않은 연결은 모두 차단되는데, 이는 중계를 원하는 노드가 접속을 원하는 노드의 IP 정보를 사전에 알고 있어야 함을 뜻합니다.</p>
<p>하지만 실생활에서 많은 사용자는 자신의 공인 IP를 알고 있지 않거나 신경쓰지 않기 때문에, 이러한 정보를 직접 전달해야한다는 건 무척이나 어려운 일입니다. 이를 해결하기 위해서 <a href=https://webrtc.org/>WebRTC</a> 같은 사용 예에서는 <a href=https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Signaling_and_video_calling>시그널링(signalling)</a> 단계에서 접속할 노드의 IP 정보를 미리 알아내곤 합니다. 한편 Libplanet에서는 STUN 프로토콜을 통해 NAT 뒤에 있는 지를 확인하고, 만약 그렇다면 STUN을 통해 확인된 IP를 공인 IP로 릴레이 된 IP/포트와 함께 다른 노드에 전파합니다. 이러한 정보를 받은 노드는, 릴레이 된 정보로 접속하기에 앞서서 먼저 공인 IP를 통해 권한 요청을 하는 절차를 거칩니다.</p>
<p>이렇게 노드가 접속을 원하는 다른 노드의 공인 IP(<code>10.1.1.1</code>)을 알고 있다면, 권한 요청은 아마 아래와 같을 것입니다.</p>
<blockquote>
<p>노드: <code>10.1.1.1</code>에서 <code>54.12.1.3:65002</code>로 오는 요청을 허가해주세요.</p>
</blockquote>
<p>이런 접근 권한은 300초의 유효기간(lifetime)이 지나면 만료되는데, 이를 방지하기 위해서는 권한을 요청했던 노드가 다시 TURN 서버에게 권한 요청을 해야 합니다.</p>
<h2 id=연결-알림-및-새-연결-요청하기>연결 알림 및 새 연결 요청하기</h2>
<p>이렇게 권한 요청 및 승인까지 끝마치고 나면, 드디어 할당 받은 IP와 포트로 승인된 다른 노드가 접속할 수 있습니다. 다른 노드가 할당된 IP와 포트를 통해 접속하면 TURN 서버는 이를 감지하여 다음과 같은 메시지를 제어 연결로 보냅니다.</p>
<blockquote>
<p>TURN 서버: <code>10.1.1.1</code>에서 <code>54.12.1.3:65002</code>로 연결 시도가 있었습니다. (연결 ID: <code>1234</code>)</p>
</blockquote>
<p>TURN 서버에 중계를 요청한 노드가 이 연결을 수락하려면, 제어 연결이 아닌 새로운 연결을 만들어서 TURN 서버에 요청하면 됩니다. 이 때 요청 받은 외부 연결을 구분하기 위해서 연결 알림 메시지의 연결 ID(connection ID)를 보내야 합니다.</p>
<blockquote>
<p>노드: 연결 <code>1234</code>에 대한 데이터는 앞으로 이 연결로 전달해주세요.</p>
</blockquote>
<p>이렇게 새롭게 생긴 연결을 <dfn>데이터 연결</dfn>(data connection)이라고 합니다.
이후 <code>54.12.1.3:65002</code>로 보내는 요청은 이 데이터 연결을 통해 전달되며, 해당 IP/포트에 연결된 노드에 응답하고 싶을때도 이 데이터 연결에 전송하면 TURN 서버를 거쳐서 노드에 전달됩니다.</p>
<h2 id=남은-일들>남은 일들</h2>
<p>실제로 응답을 제대로 보내기 위해서는, 앞서 만든 데이터 연결과 Libplanet 노드의 요청–응답용 연결을 다시 중계 할 필요가 있습니다. 이 부분은 노드 안에서만 잘 처리되면 되기 때문에 별도의 프로토콜이나 공개 표준은 정해지지 않았습니다. 만약 TURN 클라이언트가 웹 서버와 별도의 프로세스로 실행된다면 <a href=https://ko.wikipedia.org/wiki/%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4_%EA%B0%84_%ED%86%B5%EC%8B%A0>IPC</a>, 같은 프로세스라면 스레드 간 통신 등을 이용해 이를 적절히 처리해주시면 됩니다. Libplanet에서는 별도 TCP 프록시를 로컬에서 실행하여 이를 릴레이합니다.</p>
</article>
<script>(function(){var d,h,e,a,g,c,f,b;if(!location.hash.match(/^#/))return;if(d=document.getElementById('content'),h=window.decodeURIComponent(location.hash.substring(1)),e=document.getElementById(h),a=e.nodeName.match(/^H([123456])$/),!a||e.parentNode!==d)return;g=window.parseInt(a[1]),c=!1;for(f=0;f<d.childNodes.length;f++)b=d.childNodes[f],c?(a=b.nodeName.match(/^H([123456])$/),a&&window.parseInt(a[1])>=g&&(c=!1)):b===e&&(c=!0),!c&&!b.nodeName.match(/^#/)&&(b.className+=' dim')})()</script>
<div class=recruit>
<a href=https://planetariumhq.com>플라네타리움</a>은 게임에 특화된 오픈 소스 P2P 라이브러리 <a href=https://libplanet.io/>Libplanet</a>과, 그 위에서 중앙 서버 없는 온라인 게임 <a href=https://nine-chronicles.com/>나인 크로니클</a>을 만들고 있습니다. 저희와 흥미로운 기술적 도전을 함께 하실 분들을 모시고 있습니다. 지금 <a href=https://recruit.planetariumhq.com/>채용 페이지</a>를 확인해주세요!
</div>
<div itemprop=author class="fl tc mr3">
<a href=https://github.com/longfin rel=author itemprop=url class="no-underline mid-gray b f6">
<img src="https://www.gravatar.com/avatar/0b12cfcb4b1a472207af0e51f7d13a71?d=https://avatars.githubusercontent.com/longfin" itemprop=image class="w3 h3 br-100 mb1">
<br>문성원
</a>
</div>
</section>
<footer>
<div>
<p class="f6 gray mt6 lh-copy">
&copy; 2019&ndash;2021
<a href=https://planetariumhq.com/ style=color:inherit;text-decoration:inherit>Planetarium</a>.
</p>
</div>
</footer>
</body>
</html>